---
title: "Clean Analysis Dataset"
author: "Alex"
date: "`r Sys.time()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up packages and connect to RStudio Connect board
```{r}
library(tidyverse)
library(odbc)

con <- dbConnect(odbc::odbc(), "Content DB", timeout = 10)
pins::board_register_rsconnect(server = "https://colorado.rstudio.com/rsc",
                               key = Sys.getenv("RSTUDIOCONNECT_API_KEY"))
```

# Connect to Database Data
```{r, download}
DBI::dbWriteTable(con, "bike_station_info", pins::pin_get("alex.gold/bike_station_info"), overwrite = TRUE)

df_con <- dplyr::tbl(con, "bike_raw_data")
stats <- dplyr::tbl(con, "bike_station_info")
```

# Clean data
```{r}
(df <- df_con %>% 
    # Clean data
    transmute(id = station_id, 
              hour = hour(time), 
              date = date(time), 
              month = month(time),
              n_bikes = num_bikes_available, 
              dow = to_char(time, "dy")) %>%
    # Add location
    left_join(select(stats, id = station_id, lat, lon)) %>%
    # Write back to db
    compute("bike_model_data", overwrite = TRUE))
```
